<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Project: Acme Blogs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/9.1.3/mocha.css"
        integrity="sha512-Ytt2foRGKdIInPXwyS3gxRvfTv4n2wi7uB7neCLH1LjExT+PKBeQu6LNVB4QpHaJqx7m2btagBs4kqxYC1QNFg=="
        crossorigin="anonymous" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="https://serene-roentgen-345cd7.netlify.app/css/finalProject.min.css" />
    <script src="js/main.js" defer></script>
    <script src="https://serene-roentgen-345cd7.netlify.app/tests/finalProject.min.js" defer></script>
    <script src="https://serene-roentgen-345cd7.netlify.app/util/util99.min.js" defer></script>
</head>
<script src="script.js"></script>
    const API_URL = "https://jsonplaceholder.typicode.com";

/* ---------- Utility Functions ---------- */

function createElemWithText(tag = "p", text = "", className) {
  const el = document.createElement(tag);
  el.textContent = text ?? "";
  if (className) el.className = className;
  return el;
}

function deleteChildElements(parent) {
  if (!(parent instanceof HTMLElement)) return;
  while (parent.firstChild) parent.removeChild(parent.firstChild);
  return parent;
}

/* ---------- Select Menu ---------- */

function createSelectOptions(users) {
  if (!users) return;
  return users.map(user => {
    const option = document.createElement("option");
    option.value = user.id;
    option.textContent = user.name;
    return option;
  });
}

function populateSelectMenu(users) {
  if (!users) return;
  const select = document.getElementById("selectMenu");
  const options = createSelectOptions(users);
  options.forEach(opt => select.appendChild(opt));
  return select;
}

/* ---------- API Calls ---------- */

async function getUsers() {
  const res = await fetch(`${API_URL}/users`);
  return res.json();
}

async function getUser(userId) {
  if (!userId) return;
  const res = await fetch(`${API_URL}/users/${userId}`);
  return res.json();
}

async function getUserPosts(userId) {
  if (!userId) return;
  const res = await fetch(`${API_URL}/posts?userId=${userId}`);
  return res.json();
}

async function getPostComments(postId) {
  if (!postId) return;
  const res = await fetch(`${API_URL}/comments?postId=${postId}`);
  return res.json();
}

/* ---------- Comments ---------- */

function createComments(comments) {
  if (!comments) return;
  const frag = document.createDocumentFragment();

  comments.forEach(comment => {
    const article = document.createElement("article");
    article.append(
      createElemWithText("h3", comment.name),
      createElemWithText("p", comment.body),
      createElemWithText("p", `From: ${comment.email}`)
    );
    frag.append(article);
  });

  return frag;
}

async function displayComments(postId) {
  if (!postId) return;

  const section = document.createElement("section");
  section.dataset.postId = postId;
  section.classList.add("comments", "hide");

  const comments = await getPostComments(postId);
  section.append(createComments(comments));

  return section;
}

/* ---------- Toggle ---------- */

function toggleCommentSection(postId) {
  if (!postId) return;
  const section = document.querySelector(`section[data-post-id="${postId}"]`);
  if (!section) return null;
  section.classList.toggle("hide");
  return section;
}

function toggleCommentButton(postId) {
  if (!postId) return;
  const btn = document.querySelector(`button[data-post-id="${postId}"]`);
  if (!btn) return null;
  btn.textContent =
    btn.textContent === "Show Comments" ? "Hide Comments" : "Show Comments";
  return btn;
}

function toggleComments(event, postId) {
  if (!event || !postId) return;
  return [
    toggleCommentSection(postId),
    toggleCommentButton(postId)
  ];
}

/* ---------- Posts ---------- */

function createPosts(posts) {
  if (!posts) return;
  const frag = document.createDocumentFragment();

  posts.forEach(post => {
    const article = document.createElement("article");

    const h2 = createElemWithText("h2", post.title);
    const body = createElemWithText("p", post.body);
    const user = createElemWithText("p", `User ID: ${post.userId}`);
    const postId = createElemWithText("p", `Post ID: ${post.id}`);
    const btn = document.createElement("button");
    btn.textContent = "Show Comments";
    btn.dataset.postId = post.id;

    const section = document.createElement("section");
    section.classList.add("comments", "hide");
    section.dataset.postId = post.id;

    article.append(h2, body, user, postId, btn, section);
    frag.append(article);
  });

  return frag;
}

function displayPosts(posts) {
  const main = document.querySelector("main");

  if (!posts) {
    return createElemWithText("p", "Select a user to view posts", "default-text");
  }

  const frag = createPosts(posts);
  main.append(frag);
  return frag;
}

/* ---------- Buttons ---------- */

function addButtonListeners() {
  const buttons = document.querySelectorAll("main button");
  buttons.forEach(btn => {
    if (!btn.dataset.postId) return;
    btn.addEventListener("click", e =>
      toggleComments(e, btn.dataset.postId)
    );
  });
  return buttons;
}

function removeButtonListeners() {
  const buttons = document.querySelectorAll("main button");
  buttons.forEach(btn => {
    btn.replaceWith(btn.cloneNode(true));
  });
  return buttons;
}

/* ---------- Refresh ---------- */

function refreshPosts(posts) {
  if (!posts) return;
  const main = document.querySelector("main");
  deleteChildElements(main);
  return [
    displayPosts(posts),
    addButtonListeners()
  ];
}

/* ---------- Select Change ---------- */

async function selectMenuChangeEventHandler(event) {
  if (!event) return;
  const userId = event.target.value;
  const posts = await getUserPosts(userId);
  const refresh = refreshPosts(posts);
  return [userId, posts, refresh];
}

/* ---------- Init ---------- */

async function initPage() {
  const users = await getUsers();
  const select = populateSelectMenu(users);
  return [users, select];
}

async function initApp() {
  const init = await initPage();
  const select = document.getElementById("selectMenu");
  select.addEventListener("change", selectMenuChangeEventHandler);
  return init;
}

initApp();

<body>
    <header>
        <h1>Acme Blogs</h1>
        <form id="filterForm">
            <select id="selectMenu">
                <option selected>Employees</option>
            </select>
        </form>
    </header>
    <main>
        <p class="default-text">Select an Employee to display their posts.</p>
    </main>
    <footer>
        <p>Acme Company</p>
    </footer>
    <div id="mocha" class="testResults"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/9.1.3/mocha.min.js"
        integrity="sha512-lvMvODyFG9d4cHdd60PNqWrHrXuuwI4NT4hZVZBVqF95tsNY36VJbXXG/s7Fv4DO4bk/g5pAvJkbKdKdieb1+g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"
        integrity="sha512-gkZWobgJrQevN2HMEeTnSlxWPJ3HS0JJ3nXcgI6XLK/NI0z59jbztRZqbTlIzfl21vIGahQaeW0knwH1az/tbg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        mocha.setup("bdd");
    </script>
</body>

</html>
